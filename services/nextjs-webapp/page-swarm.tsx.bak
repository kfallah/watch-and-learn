'use client'

import { useState, useEffect, useCallback } from 'react'
import BrowserGrid, { WorkerInfo } from '@/components/BrowserGrid'
import ChatWindow from '@/components/ChatWindow'

/**
 * Multi-Agent Browser Swarm Page with Single/Multi-Agent Toggle
 *
 * Single Agent Mode: One browser, direct connection to worker-1 (faster performance)
 * Multi-Agent Mode: Two browsers in grid, orchestrator distributes tasks
 */
export default function SwarmHome() {
  const [workers, setWorkers] = useState<WorkerInfo[]>([])
  const [orchestratorConnected, setOrchestratorConnected] = useState(false)
  const [agentMode, setAgentMode] = useState<'single' | 'multi'>('single')

  // Get worker count from environment (default 2)
  const workerCount = parseInt(process.env.NEXT_PUBLIC_WORKER_COUNT || '2')

  // Initialize workers
  useEffect(() => {
    const initialWorkers: WorkerInfo[] = []
    for (let i = 1; i <= workerCount; i++) {
      initialWorkers.push({
        worker_id: i,
        status: 'idle',
        assigned_company: null,
        ports: {
          agent: 8000 + i,
          video: 8765 + i,
        },
      })
    }
    setWorkers(initialWorkers)
  }, [workerCount])

  // Connect to orchestrator WebSocket for status updates (only in multi mode)
  const connectOrchestrator = useCallback(() => {
    if (agentMode !== 'multi') return null

    const wsUrl =
      process.env.NEXT_PUBLIC_ORCHESTRATOR_URL ||
      `ws://${typeof window !== 'undefined' ? window.location.hostname : 'localhost'}:8100/ws`

    const ws = new WebSocket(wsUrl)

    ws.onopen = () => {
      setOrchestratorConnected(true)
      console.log('Connected to orchestrator')
    }

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data)

        // Update workers status when we receive updates
        if (data.data?.workers && Array.isArray(data.data.workers)) {
          setWorkers(data.data.workers)
        }

        // Handle task progress updates
        if (data.type === 'status' && data.data?.companies) {
          const companies: string[] = data.data.companies
          setWorkers((prev) =>
            prev.map((w, idx) => ({
              ...w,
              status: idx < companies.length ? 'running' : w.status,
              assigned_company: companies[idx] || w.assigned_company,
            }))
          )
        }

        // Reset workers on task completion
        if (data.type === 'response') {
          setTimeout(() => {
            setWorkers((prev) =>
              prev.map((w) => ({
                ...w,
                status: 'idle',
                assigned_company: null,
              }))
            )
          }, 2000)
        }
      } catch (e) {
        console.error('Failed to parse orchestrator message:', e)
      }
    }

    ws.onclose = () => {
      setOrchestratorConnected(false)
      console.log('Disconnected from orchestrator')
      // Reconnect after delay if still in multi mode
      setTimeout(() => {
        if (agentMode === 'multi') connectOrchestrator()
      }, 3000)
    }

    ws.onerror = (error) => {
      console.error('Orchestrator WebSocket error:', error)
    }

    return ws
  }, [agentMode])

  useEffect(() => {
    const ws = connectOrchestrator()
    return () => {
      ws?.close()
    }
  }, [connectOrchestrator])

  return (
    <main className="flex h-screen bg-gray-900 text-white">
      {/* Browser View - Left Panel */}
      <div className="flex-1 flex flex-col min-w-0">
        {/* Header with Agent Mode toggle */}
        <div className="flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700">
          <div className="flex items-center gap-4">
            <h1 className="text-lg font-semibold">
              {agentMode === 'single' ? 'ü§ñ Single Agent' : 'üêù Multi-Agent Swarm'}
            </h1>
            {agentMode === 'multi' && (
              <div className="flex items-center gap-2 text-sm">
                <div
                  className={`w-2 h-2 rounded-full ${
                    orchestratorConnected ? 'bg-green-500' : 'bg-red-500'
                  }`}
                ></div>
                <span className="text-gray-400">
                  {orchestratorConnected ? 'Connected' : 'Disconnected'}
                </span>
              </div>
            )}
          </div>

          {/* Agent Mode Toggle */}
          <div className="flex items-center gap-3">
            <div className="flex rounded-lg overflow-hidden border border-gray-600">
              <button
                onClick={() => setAgentMode('single')}
                className={`px-4 py-1.5 text-sm font-medium transition-colors ${
                  agentMode === 'single'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }`}
              >
                ‚ö° Single Agent
              </button>
              <button
                onClick={() => setAgentMode('multi')}
                className={`px-4 py-1.5 text-sm font-medium transition-colors ${
                  agentMode === 'multi'
                    ? 'bg-purple-600 text-white'
                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }`}
              >
                üîÄ Multi-Agent
              </button>
            </div>

            {/* Worker count badge (only in multi mode) */}
            {agentMode === 'multi' && (
              <span className="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">
                {workers.filter((w) => w.status === 'running').length} / {workers.length} active
              </span>
            )}
          </div>
        </div>

        {/* Browser View */}
        <div className="flex-1 min-h-0">
          {agentMode === 'single' ? (
            // Single Agent Mode: Full-size view of worker-1 only
            <BrowserGrid
              workers={workers.filter((w) => w.worker_id === 1)}
              activeCount={1}
            />
          ) : (
            // Multi-Agent Mode: Grid of all workers
            <BrowserGrid workers={workers} />
          )}
        </div>

        {/* Mode description */}
        <div className="px-4 py-2 bg-gray-800/50 border-t border-gray-700 text-xs text-gray-500">
          {agentMode === 'single' ? (
            <span>‚ö° Direct connection to agent ‚Äî lower latency, single browser control</span>
          ) : (
            <span>üîÄ Orchestrator distributes tasks across {workers.length} workers in parallel</span>
          )}
        </div>
      </div>

      {/* Chat Window - Right Panel */}
      <div className="w-[400px] h-full flex flex-col bg-gray-800 border-l border-gray-700">
        <ChatWindow
          isRecording={false}
          useOrchestrator={agentMode === 'multi'}
        />
      </div>
    </main>
  )
}
